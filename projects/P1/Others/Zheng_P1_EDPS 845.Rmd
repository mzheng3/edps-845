---
title: "Zheng_P1_EDPS 845"
author: "Zheng"
date: "May 27, 2016"
output: html_document
---
```{r}
install.packages("PerFit")
install.packages("itm")
install.packages("mirt")
install.packages("irtoys")
library("PerFit")

# Parametric model imputation
# Item scores are generated from Bernoulli distributions, with probabilities estimated by means of parametric IRT models
#     (1PLM, 2PLM, 3PLM):
PModel.imputation <- function(matrix, save.matImp, ip, model, ability, method, mu, sigma, ML)
{
  N <- dim(matrix)[1]; I <- dim(matrix)[2]
  
  # Estimate item parameters if not provided (using 'irtoys'):
  library(irtoys)
  ip <- estIP(matrix, ip, model)
  
  # Estimate ability parameters if not provided (using 'irtoys'):
  ability <- estAb(matrix, ip, ability, method, mu, sigma, ml)
  
  A   <- ip[, 1]; B <- ip[, 2]; C <- ip[, 3]
  P   <- do.call(cbind, lapply(1:I, function (x) {C[x] + (1 - C[x]) / (1 + exp(-A[x] * (ability - B[x])))}))
  # 
  matrix.imp  <- matrix
  position.NA <- which(is.na(matrix) == 1, arr.ind = TRUE)
  P.NA        <- P[position.NA]
  matrix.imp[position.NA] <- rbinom(length(P.NA), 1, P.NA)
  # 
  if (save.matImp == TRUE)
  {
    write.matrix(matrix.imp, file="Datamatrix_imputted.txt", sep=" ")
  }
  return(list(matrix.imp, ip, ability, 1))
}

??irt.PModel


```


















































This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



#Zheng P1 EDPS 845
```{r}
library(epmr)
epmr::irtstudy
library(lme4)
install.packages("Matrix")
lme4::glmer
for(i in 1:11)
  
  
  write.txt(PISA$totals[[i]], file = paste0("test", i, ".txt"))

booklet1 <- read.delim("C:/Users/Zheng/Desktop/Summer 2016/edps-845/projects/Booklet1.txt", header=FALSE)
View(Booklet1)


booklet1 <- read.delim("booklet1", row.names = 1)
irtstudy()


```
?"knitr"

library(equate)
library(knitr)
test1 <- read.csv("test1.csv", row.names = 1) 
setwd("C:/Users/Zheng/Desktop/Summer 2016/EDPS 845 R/edps-845/in-class/")

(f = system.file(test1, "knitr-minimal.Rnw", package = "knitr"))
knit(f)  # compile to tex

purl(f)  # tangle R code
purl(f, documentation = 0)  # extract R code only
purl(f, documentation = 2)  # also include documentation


```{r}
#Rewrite the loop replacing tapply with our own function
dstudy2 <- function(thetest){
  out <- matrix(NA, nrow = length(levels(thetest$schoolid)), ncol = 9)

  for(j in 1:4){
    out[j, ] <- unlist(tapply(thetest[,j], thetest$schoolid, epmr::dstudy))
  
  }
  return(out)
}

# Rewrite without the for loop
dstudy3 <- function(thetest, whatcols, another = "blabla") {
  apply(thetest[, whatcols], 2, dstudy)
} # another = "blabla", ... to add/define a different function within a function.

#test it
lapply(test, function(x) apply(x[, 1:4], 2, dstudy)) # lappy = list of apply
lapply(test$test1, dstudy2)
lapply(test$test1, dstudy3)

```


